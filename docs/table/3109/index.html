<!DOCTYPE html>
<html lang="ja">
<head>
<title>お皿が未熟難易度表</title>
<meta charset="UTF-8">
<meta name="bmstable" content="./head.json" />
<link href="./style.css" rel="stylesheet" type="text/css" media="screen,print" />
<script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>
<script language="javascript" type="text/javascript">
// 取得処理
const getJson = (url, fn) => {
    let xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.onload = () => {
        let responseJson = JSON.parse(xhr.response);
        fn(responseJson);
    }
    xhr.send();
}
const getTableData = (res) => {
    getJson(res.data_url, (infomation) => {
        makeBMSTable(infomation, res.symbol)
    });
}
window.addEventListener('load', (event) => {
    const description_url = document.getElementsByName('bmstable')[0].content;
    getJson(description_url, getTableData);
});

// 表生成処理
const makeBMSTable = (info, mark) => {
    var x = "";
    var ev = "";
    var count = 0;
    var obj = $("#table_int");
    // 表のクリア
    obj.html("");
    $("<tr height='20' style='color:white;background-color:#666666'><td align='center'>LV</td><td align='center'>タイトル</td><td align='center'>本体</td><td align='center'>差分</td><td align='center'>コメント</td></tr>").appendTo(obj);
    var obj_sep = null;
    info.forEach((current, i) => {
        // 難度ごとの区切り
        if (x != current.level) {
            // 前の区切りに譜面数、平均密度を追加
                if (obj_sep != null) {
                obj_sep.html("<td colspan='6' align='center'>" + "<b>" + mark + x + " (" + count + "譜面)</b></td>");
            }
            obj_sep = $("<tr class='tr_separate' id='" + mark + current.level + "'></tr>");
            obj_sep.appendTo(obj);
            count = 0;
            x = current.level; // クソ実装すぎ
        }
        // 本文
        var str = $("<tr class='tr_normal'></tr>");
        if(current.state == 1) {
        str = $("<tr class='tr_new'></tr>");
        }
        if(current.state == 2) {        
        str = $("<tr class='tr_update'></tr>");
        }
        // レベル表記
        $("<td width='5%'>" + mark + x + "</td>").appendTo(str);
        // タイトル
        $("<td width='20%'>" + "<a href='http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" + current.md5 + "' target='_blank'>" + current.title + "</a></td>").appendTo(str);
        // アーティスト
        var astr = "";
        if(current.url != null) {
            if(current.artist != null) {
                astr = "<a href='" + current.url + "'>" + current.artist + "</a>";
            } else {
                astr = "<a href='" + current.url + "'>" + current.url + "</a>";
            }
        } else {
            if(current.artist != null) {
                astr = current.artist;
            }
        }
        // 多分本体情報
        if(current.url_pack != null) {
            if(current.name_pack != null) {
                astr += "<br />(<a href='" + current.url_pack + "'>" + current.name_pack + "</a>)";
            } else {
                astr += "<br />(<a href='" + current.url_pack + "'>" + current.url_pack + "</a>)";
            }
        } else {
            if(current.name_pack != null) {
                astr += "<br />(" + current.name_pack + ")";
            }
        }
        $("<td width='20%'>" + astr + "</td>").appendTo(str);
        // 差分
        if(current.url_diff != null) {
            const download_url = current.url_diff ? current.url_diff.replace(/^(_*)?/, '') : '';
            const name         = current.name_diff ? current.name_diff : current.url_diff;
            $("<td width='10%'><a href='./bms/" + download_url + "' download='"+current.url_diff+"'>" + name + "</a></td>").appendTo(str);
        } else {
            if(current.name_diff != null) {
            $("<td width='10%'>" + current.name_diff + "</td>").appendTo(str);
            } else {
            $("<td width='10%'></td>").appendTo(str);
            }
        }
        // コメント
        const comment = current.comment ? current.comment : '';
        $("<td width='15%'>" + comment + "</td>").appendTo(str);
        str.appendTo(obj);
        count++;

    });
    // 最後の区切り処理
    if (obj_sep != null) {
        obj_sep.html("<td colspan='6' align='center'>" + "<b>" + mark + x + " (" + count + "譜面)</b></td>");
    }
}
</script>
</head>
<body class="diff">
<p style="color:#ffffee">お皿が未熟難易度表</p>
<p style="color:#ffffee">代理です</p>
<div class="tableflame">
<table align="center" cellspacing="1" cellpadding="2" border="0" bgcolor="#000000" id="table_int">
</table>
</div>

</body>
</html>