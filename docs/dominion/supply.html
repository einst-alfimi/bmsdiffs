<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>推奨サプライ選択ツール</title>
  <style>
    body { font-family: sans-serif; max-width: 640px; margin: 1rem auto; padding: 0 1rem; }
    select { width: 100%; padding: 0.5rem; font-size: 1rem; }
    .result { margin-top: 1rem; padding: 1rem; background: #f0f0f0; border-radius: 8px; }
    .result h2 { margin-top: 0; }
    .card-list { list-style: none; padding-left: 0; }
    .card-list li { padding: 0.25rem 0; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; gap: 1rem; }
    .card-list li:last-child { border-bottom: none; }
    .card-set { color: #666; font-size: 0.9em; }
    .card-types { font-size: 0.85em; color: #555; margin-right: auto; }
    .colony-shelter { margin-top: 1rem; display: flex; gap: 2rem; }
    .colony-shelter span { font-weight: bold; }
  </style>
</head>
<body>
  <h1>推奨サプライ一覧</h1>
  <p>
    <label for="supply-select">サプライ選択:</label><br>
    <select id="supply-select" size="1"></select>
  </p>
  <div id="cards-result" class="result">
    <h2>王国カード</h2>
    <ul id="kingdom-list" class="card-list"></ul>
    <h2>追加カード</h2>
    <ul id="extra-list" class="card-list"></ul>
    <div id="colony-shelter" class="colony-shelter"></div>
  </div>

  <script type="module">
    const selectEl = document.getElementById('supply-select');
    const kingdomListEl = document.getElementById('kingdom-list');
    const extraListEl = document.getElementById('extra-list');
    const colonyShelterEl = document.getElementById('colony-shelter');

    function normalizeName(s) {
      if (!s || typeof s !== 'string') return '';
      return s.trim();
    }

    /** dominion_cards.json から カード名(日本語) -> カードデータ の Map を構築 */
    function buildCardDataLookup(dominionCardsData) {
      const map = new Map();
      if (!dominionCardsData?.cards) return map;
      for (const c of dominionCardsData.cards) {
        const nameJa = normalizeName(c.name_ja ?? '');
        if (nameJa && !map.has(nameJa)) map.set(nameJa, c);
      }
      return map;
    }

    function getSetForCardName(cardName, cardDataLookup) {
      if (!cardName || !cardDataLookup) return '—';
      const card = cardDataLookup.get(normalizeName(cardName));
      return card?.set ?? '—';
    }

    function getTypeForCardName(cardName, cardDataLookup) {
      if (!cardName || !cardDataLookup) return '';
      const card = cardDataLookup.get(normalizeName(cardName));
      return card?.type ?? '';
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function renderCardList(listEl, cards, cardDataLookup) {
      listEl.innerHTML = '';
      if (!cards?.length) {
        const li = document.createElement('li');
        li.textContent = '（なし）';
        listEl.appendChild(li);
        return;
      }
      const sortedCards = [...cards].sort((a, b) => {
        const setA = getSetForCardName(a.name, cardDataLookup);
        const setB = getSetForCardName(b.name, cardDataLookup);
        return setA.localeCompare(setB, 'ja');
      });

      for (const card of sortedCards) {
        const set = getSetForCardName(card.name, cardDataLookup);
        const type = getTypeForCardName(card.name, cardDataLookup);
        const li = document.createElement('li');
        li.innerHTML = `<span>${escapeHtml(card.name)}${card.cost ? ` (${escapeHtml(card.cost)})` : ''}</span><span class="card-types">${escapeHtml(type)}</span><span class="card-set">${escapeHtml(set)}</span>`;
        listEl.appendChild(li);
      }
    }

    function renderColonyShelter(item) {
      const colony = item.colony === true;
      const shelter = item.shelter === true;
      colonyShelterEl.innerHTML = `
        <div><span>植民地/プラチナ:</span> ${colony ? '使用' : '不使用'}</div>
        <div><span>避難所:</span> ${shelter ? '使用' : '不使用'}</div>
      `;
    }

    async function init() {
      const [listRes, cardsRes] = await Promise.all([
        fetch('supply_list.json'),
        fetch('dominion_cards.json'),
      ]);
      if (!listRes.ok || !cardsRes.ok) {
        selectEl.innerHTML = '<option>JSON の読み込みに失敗しました（ローカルで開く場合はサーバーが必要です）</option>';
        return;
      }
      const supplyListData = await listRes.json();
      const dominionCardsData = await cardsRes.json();
      const cardDataLookup = buildCardDataLookup(dominionCardsData);
      const supplyList = supplyListData.supplies ?? [];

      supplyList.forEach((item, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${item.expansion} — ${item.name}`;
        selectEl.appendChild(opt);
      });

      function update() {
        const index = parseInt(selectEl.value, 10);
        const item = supplyList[index];
        if (!item) return;
        renderCardList(kingdomListEl, item.kingdom_cards ?? [], cardDataLookup);
        renderCardList(extraListEl, item.extra_cards ?? [], cardDataLookup);
        renderColonyShelter(item);
      }

      selectEl.addEventListener('change', update);
      update();
    }

    init();
  </script>
</body>
</html>
